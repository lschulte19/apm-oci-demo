name: OCI Token Exchange via GitHub OIDC

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  exchange-token:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Obter ID Token do GitHub OIDC
        id: oidc
        run: |
          echo "Solicitando token OIDC via GitHub Actions..."

          TOKEN_JSON=$(curl -sSL "$ACTIONS_ID_TOKEN_REQUEST_URL" \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN")

          ID_TOKEN=$(echo "$TOKEN_JSON" | jq -r .value)

          if [ -z "$ID_TOKEN" ] || [ "$ID_TOKEN" == "null" ]; then
            echo "Erro: ID_TOKEN não recebido"
            exit 1
          fi

          echo "::add-mask::$ID_TOKEN"
          echo "ID_TOKEN=$ID_TOKEN" >> $GITHUB_ENV
          echo "Token JWT OIDC recebido com sucesso."

      - name: Fazer Token Exchange (JWT → UPST) na OCI
        run: |
          echo "Trocando token via Identity Domain da OCI..."

          TOKEN_RESPONSE=$(curl -s -X POST \
            "https://idcs-c3fbb3ae829b4af0a98995e5f1549f09.identity.oraclecloud.com/oauth2/v1/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=urn:ietf:params:oauth:grant-type:token-exchange" \
            --data-urlencode "subject_token_type=urn:ietf:params:oauth:token-type:jwt" \
            --data-urlencode "requested_token_type=urn:opc:token-type:upst" \
            --data-urlencode "subject_token=$ID_TOKEN")

          echo "Resposta do Token Exchange:"
          echo "$TOKEN_RESPONSE" | jq

          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" == "null" ]; then
            echo "Falha ao obter o token UPST"
            exit 1
          fi

          echo "::add-mask::$ACCESS_TOKEN"
          echo "UPST=$ACCESS_TOKEN" >> $GITHUB_ENV

      - name: Testar chamada na API da OCI com o UPST
        run: |
          echo "Chamando API da OCI com o UPST..."

          curl -s -X GET \
            -H "Authorization: Bearer $UPST" \
            -H "Content-Type: application/json" \
            "https://identity.us-ashburn-1.oraclecloud.com/20160918/users/" | jq
